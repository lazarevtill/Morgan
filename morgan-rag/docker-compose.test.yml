# =============================================================================
# Morgan v2-0.0.1 - Testing Docker Compose Configuration
# =============================================================================
# Testing setup with isolated environments and test databases
#
# Usage:
#   Run tests:
#     docker-compose -f docker-compose.test.yml up --abort-on-container-exit
#
#   Run specific test suite:
#     docker-compose -f docker-compose.test.yml run --rm test-runner pytest tests/unit
#
#   Run with coverage:
#     docker-compose -f docker-compose.test.yml run --rm test-runner pytest --cov=morgan
#
#   Cleanup after tests:
#     docker-compose -f docker-compose.test.yml down -v
#
# Features:
#   - Isolated test databases
#   - Ephemeral volumes (cleaned up after tests)
#   - Parallel test execution
#   - Coverage reporting
#   - Integration test support
# =============================================================================

version: '3.8'

# =============================================================================
# Services (Testing Configuration)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Test Runner - Main Testing Service
  # ---------------------------------------------------------------------------
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
      args:
        - PYTHON_VERSION=3.11
    image: morgan-rag:test
    container_name: morgan-test-runner

    volumes:
      # Mount source code
      - ./morgan:/app/morgan:ro
      - ./tests:/app/tests:ro
      - ./config:/app/config:ro

      # Test results and coverage
      - ./test-results:/app/test-results
      - ./coverage:/app/coverage

      # pytest configuration
      - ./config/pytest.ini:/app/pytest.ini:ro

    environment:
      # Test environment
      - MORGAN_ENVIRONMENT=test
      - MORGAN_DEV_MODE=true
      - MORGAN_DEBUG=true
      - MORGAN_LOG_LEVEL=DEBUG

      # Test databases
      - QDRANT_URL=http://qdrant-test:6333
      - REDIS_URL=redis://redis-test:6379/0
      - DATABASE_URL=postgresql://morgan_test:test_password@postgres-test:5432/morgan_test

      # LLM (mock for testing)
      - LLM_BASE_URL=http://mock-llm:8080
      - LLM_API_KEY=test-api-key
      - LLM_MODEL=mock-model

      # Test settings
      - MORGAN_WORKERS=2
      - MORGAN_CACHE_SIZE=10
      - MORGAN_MAX_SEARCH_RESULTS=10

      # Pytest configuration
      - PYTEST_ARGS=${PYTEST_ARGS:---verbose --tb=short}

      # Python
      - PYTHONPATH=/app
      - PYTHONDONTWRITEBYTECODE=1

    command: >
      pytest
      --verbose
      --tb=short
      --color=yes
      --maxfail=5
      --junit-xml=/app/test-results/junit.xml
      --html=/app/test-results/report.html
      --self-contained-html

    depends_on:
      qdrant-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
      postgres-test:
        condition: service_healthy

    networks:
      - morgan-test-network

  # ---------------------------------------------------------------------------
  # Unit Test Runner - Fast Unit Tests Only
  # ---------------------------------------------------------------------------
  unit-tests:
    extends: test-runner
    container_name: morgan-unit-tests
    command: >
      pytest tests/unit
      --verbose
      --tb=short
      --color=yes
      --maxfail=10
      -m "unit"

  # ---------------------------------------------------------------------------
  # Integration Test Runner - Integration Tests
  # ---------------------------------------------------------------------------
  integration-tests:
    extends: test-runner
    container_name: morgan-integration-tests
    command: >
      pytest tests/integration
      --verbose
      --tb=short
      --color=yes
      --maxfail=5
      -m "integration"

  # ---------------------------------------------------------------------------
  # Coverage Test Runner - Tests with Coverage
  # ---------------------------------------------------------------------------
  coverage-tests:
    extends: test-runner
    container_name: morgan-coverage-tests
    command: >
      pytest
      --verbose
      --cov=morgan
      --cov-report=html:/app/coverage/html
      --cov-report=xml:/app/coverage/coverage.xml
      --cov-report=term-missing
      --cov-branch
      --cov-fail-under=80

  # ---------------------------------------------------------------------------
  # Qdrant Test Database
  # ---------------------------------------------------------------------------
  qdrant-test:
    image: qdrant/qdrant:latest
    container_name: morgan-qdrant-test

    # Use ephemeral storage
    tmpfs:
      - /qdrant/storage

    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=WARNING

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    networks:
      - morgan-test-network

  # ---------------------------------------------------------------------------
  # Redis Test Cache
  # ---------------------------------------------------------------------------
  redis-test:
    image: redis:7-alpine
    container_name: morgan-redis-test

    # Use ephemeral storage
    tmpfs:
      - /data

    command: >
      redis-server
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --loglevel warning

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    networks:
      - morgan-test-network

  # ---------------------------------------------------------------------------
  # PostgreSQL Test Database
  # ---------------------------------------------------------------------------
  postgres-test:
    image: postgres:16-alpine
    container_name: morgan-postgres-test

    # Use ephemeral storage
    tmpfs:
      - /var/lib/postgresql/data

    environment:
      - POSTGRES_DB=morgan_test
      - POSTGRES_USER=morgan_test
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_HOST_AUTH_METHOD=trust

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U morgan_test -d morgan_test"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    networks:
      - morgan-test-network

  # ---------------------------------------------------------------------------
  # Mock LLM Service (for testing without real LLM)
  # ---------------------------------------------------------------------------
  mock-llm:
    image: alpine:latest
    container_name: morgan-mock-llm
    command: >
      sh -c "
        apk add --no-cache python3 py3-pip &&
        pip3 install fastapi uvicorn &&
        python3 -c 'from fastapi import FastAPI; app = FastAPI(); @app.post(\"/chat/completions\"); async def chat(): return {\"choices\": [{\"message\": {\"content\": \"Test response\"}}]}' &&
        uvicorn main:app --host 0.0.0.0 --port 8080
      "

    networks:
      - morgan-test-network

  # ---------------------------------------------------------------------------
  # Linting Service
  # ---------------------------------------------------------------------------
  lint:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    image: morgan-rag:test
    container_name: morgan-lint

    volumes:
      - ./morgan:/app/morgan:ro
      - ./tests:/app/tests:ro
      - ./config/ruff.toml:/app/ruff.toml:ro

    command: >
      sh -c "
        echo 'Running Ruff linter...' &&
        ruff check morgan tests &&
        echo 'Running Ruff formatter check...' &&
        ruff format --check morgan tests
      "

    networks:
      - morgan-test-network

  # ---------------------------------------------------------------------------
  # Type Checking Service
  # ---------------------------------------------------------------------------
  type-check:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    image: morgan-rag:test
    container_name: morgan-type-check

    volumes:
      - ./morgan:/app/morgan:ro
      - ./tests:/app/tests:ro
      - ./config/mypy.ini:/app/mypy.ini:ro

    command: >
      sh -c "
        echo 'Running MyPy type checker...' &&
        mypy --config-file mypy.ini morgan
      "

    networks:
      - morgan-test-network

  # ---------------------------------------------------------------------------
  # Security Scanning Service
  # ---------------------------------------------------------------------------
  security-scan:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    image: morgan-rag:test
    container_name: morgan-security-scan

    volumes:
      - ./morgan:/app/morgan:ro
      - ./requirements.txt:/app/requirements.txt:ro

    command: >
      sh -c "
        echo 'Running Bandit security scanner...' &&
        pip install bandit &&
        bandit -r morgan -f json -o /app/test-results/bandit.json &&
        echo 'Running safety check...' &&
        pip install safety &&
        safety check --json > /app/test-results/safety.json
      "

    networks:
      - morgan-test-network

# =============================================================================
# Networks
# =============================================================================

networks:
  morgan-test-network:
    name: morgan-test-network
    driver: bridge

# =============================================================================
# Note: No persistent volumes for testing
# All data is ephemeral and cleaned up after tests
# =============================================================================
