# =============================================================================
# Morgan v2-0.0.1 - Production Docker Compose Configuration
# =============================================================================
# Production-ready setup with security hardening, monitoring, and high availability
#
# Usage:
#   Start with production config:
#     docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
#   With environment file:
#     docker-compose --env-file .env.production -f docker-compose.prod.yml up -d
#
# IMPORTANT SECURITY CHECKLIST:
#   ✓ Change all default passwords in .env.production
#   ✓ Enable TLS/SSL certificates
#   ✓ Configure firewall rules
#   ✓ Set up backup procedures
#   ✓ Enable monitoring and alerting
#   ✓ Review and restrict CORS origins
#   ✓ Enable rate limiting
#   ✓ Use secrets management (Docker secrets or external vault)
# =============================================================================

version: '3.8'

# =============================================================================
# Services (Production Configuration)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Morgan RAG Service - Production Configuration
  # ---------------------------------------------------------------------------
  morgan:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        - PYTHON_VERSION=3.11
        - BUILD_DATE=${BUILD_DATE:-}
        - VERSION=${VERSION:-v2-0.0.1}
        - VCS_REF=${VCS_REF:-}
    image: morgan-rag:${VERSION:-latest}
    container_name: morgan-rag-prod
    restart: always

    # Production ports (use reverse proxy)
    ports:
      - "127.0.0.1:8080:8080"  # Internal only (behind nginx)
      - "127.0.0.1:8000:8000"  # Internal only (behind nginx)

    volumes:
      # Read-only mounts for security
      - ./config:/app/config:ro
      - ./knowledge:/app/knowledge:ro

      # Writable mounts
      - morgan_data:/app/data
      - morgan_logs:/app/logs

      # Shared model caches
      - model_cache_huggingface:/root/.cache/huggingface:ro
      - model_cache_torch:/root/.cache/torch:ro

    environment:
      # Production mode
      - MORGAN_ENVIRONMENT=production
      - MORGAN_DEV_MODE=false
      - MORGAN_DEBUG=false
      - MORGAN_AUTO_RELOAD=false
      - MORGAN_LOG_LEVEL=INFO

      # LLM Configuration (from secrets)
      - LLM_BASE_URL=${LLM_BASE_URL}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_MODEL=${LLM_MODEL}

      # Databases
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - DATABASE_URL=${DATABASE_URL}

      # Security
      - MORGAN_API_KEY=${MORGAN_API_KEY}
      - MORGAN_SESSION_SECRET=${MORGAN_SESSION_SECRET}
      - MORGAN_CORS_ORIGINS=${MORGAN_CORS_ORIGINS}
      - MORGAN_ALLOW_CODE_EXECUTION=false

      # Performance (scaled for production)
      - MORGAN_WORKERS=8
      - MORGAN_CACHE_SIZE=5000
      - MORGAN_CACHE_TTL=7200

      # Features
      - MORGAN_DOCS_ENABLED=false  # Disable in production
      - MORGAN_REQUEST_LOGGING=true
      - MORGAN_METRICS_ENABLED=true

      # Behind reverse proxy
      - BEHIND_PROXY=true

      # Python
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app

    # Production entrypoint (optimized)
    command: >
      gunicorn morgan.main:app
      --bind 0.0.0.0:8080
      --workers 8
      --worker-class uvicorn.workers.UvicornWorker
      --timeout 120
      --graceful-timeout 30
      --keep-alive 5
      --max-requests 1000
      --max-requests-jitter 100
      --access-logfile /app/logs/access.log
      --error-logfile /app/logs/error.log
      --log-level info

    depends_on:
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        compress: "true"

    networks:
      - morgan-network

  # ---------------------------------------------------------------------------
  # Qdrant Vector Database - Production Configuration
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:latest
    container_name: morgan-qdrant-prod
    restart: always

    ports:
      - "127.0.0.1:6333:6333"  # Internal only
      - "127.0.0.1:6334:6334"  # Internal only

    volumes:
      - qdrant_data_prod:/qdrant/storage
      - ./qdrant/config:/qdrant/config:ro

    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    networks:
      - morgan-network

  # ---------------------------------------------------------------------------
  # Redis Cache - Production Configuration
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: morgan-redis-prod
    restart: always

    ports:
      - "127.0.0.1:6379:6379"  # Internal only

    volumes:
      - redis_data_prod:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro

    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --loglevel notice

    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    networks:
      - morgan-network

  # ---------------------------------------------------------------------------
  # PostgreSQL Database - Production Configuration
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: morgan-postgres-prod
    restart: always

    ports:
      - "127.0.0.1:5432:5432"  # Internal only

    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./database/backups:/backups

    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --locale=C
      - PGDATA=/var/lib/postgresql/data/pgdata

    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c max_connections=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=5MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    networks:
      - morgan-network

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy - Production
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: morgan-nginx-prod
    restart: always

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx

    depends_on:
      - morgan

    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

    networks:
      - morgan-network

  # ---------------------------------------------------------------------------
  # Prometheus - Monitoring
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: morgan-prometheus-prod
    restart: always

    ports:
      - "127.0.0.1:9090:9090"

    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    networks:
      - morgan-network

  # ---------------------------------------------------------------------------
  # Grafana - Visualization
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: morgan-grafana-prod
    restart: always

    ports:
      - "127.0.0.1:3000:3000"

    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro

    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://monitoring.yourdomain.com
      - GF_INSTALL_PLUGINS=

    depends_on:
      - prometheus

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    networks:
      - morgan-network

# =============================================================================
# Volumes (Production)
# =============================================================================

volumes:
  morgan_data:
    driver: local
    name: morgan_data_prod

  morgan_logs:
    driver: local
    name: morgan_logs_prod

  qdrant_data_prod:
    driver: local
    name: morgan_qdrant_data_prod

  redis_data_prod:
    driver: local
    name: morgan_redis_data_prod

  postgres_data_prod:
    driver: local
    name: morgan_postgres_data_prod

  model_cache_huggingface:
    driver: local
    name: morgan_model_cache_huggingface

  model_cache_torch:
    driver: local
    name: morgan_model_cache_torch

  nginx_cache:
    driver: local
    name: morgan_nginx_cache

  nginx_logs:
    driver: local
    name: morgan_nginx_logs

  prometheus_data:
    driver: local
    name: morgan_prometheus_data

  grafana_data:
    driver: local
    name: morgan_grafana_data

# =============================================================================
# Networks
# =============================================================================

networks:
  morgan-network:
    name: morgan-network-prod
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16
