name: Linting

on:
  pull_request:
    branches: [ main, develop, claude/** ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  UV_INDEX_URL: https://nexus.in.lazarev.cloud/repository/pypi-proxy/simple
  PIP_INDEX_URL: https://nexus.in.lazarev.cloud/repository/pypi-proxy/simple

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup NetBird VPN
        uses: ./.github/actions/setup-netbird
        with:
          setup-key: ${{ secrets.NETBIRD_SETUP_KEY }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install linting tools
        run: |
          uv pip install --system black isort ruff mypy types-PyYAML types-redis
          uv pip install --system -r morgan-rag/requirements.txt

      - name: Run Black (format check)
        run: |
          black --check --diff morgan-rag/morgan/ tests/
        continue-on-error: true

      - name: Run isort (import sort check)
        run: |
          isort --check-only --diff morgan-rag/morgan/ tests/
        continue-on-error: true

      - name: Run Ruff (linting)
        run: |
          ruff check morgan-rag/morgan/ tests/ --output-format=github
        continue-on-error: true

      - name: Run Mypy (type checking)
        run: |
          # Note: --ignore-missing-imports is used for third-party libraries without type stubs
          # Consider enabling --strict in future for more comprehensive type checking
          mypy morgan-rag/morgan/ --ignore-missing-imports
        continue-on-error: true

      - name: Check Python syntax
        run: |
          find morgan-rag/morgan -type f -name '*.py' -exec python -m py_compile {} +

      - name: Cleanup NetBird VPN
        if: always()
        uses: ./.github/actions/cleanup-netbird

  format-check:
    name: Formatting Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup NetBird VPN
        uses: ./.github/actions/setup-netbird
        with:
          setup-key: ${{ secrets.NETBIRD_SETUP_KEY }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Black
        run: |
          uv pip install --system black

      - name: Check Black formatting
        id: black-check
        run: |
          black --check morgan-rag/morgan/ tests/ || echo "needs_formatting=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment on PR if formatting needed
        if: steps.black-check.outputs.needs_formatting == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ Code formatting issues detected. Please run `make format` or `black morgan-rag/morgan/ tests/` to fix.'
            })

      - name: Cleanup NetBird VPN
        if: always()
        uses: ./.github/actions/cleanup-netbird

  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup NetBird VPN
        uses: ./.github/actions/setup-netbird
        with:
          setup-key: ${{ secrets.NETBIRD_SETUP_KEY }}

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint.yml config/ .github/workflows/ docker-compose.yml
        continue-on-error: true

      - name: Cleanup NetBird VPN
        if: always()
        uses: ./.github/actions/cleanup-netbird

  dockerfile-lint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint on Morgan RAG Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: morgan-rag/Dockerfile
          ignore: DL3008,DL3013,DL3015
        continue-on-error: true

  shell-check:
    name: Shell Script Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
        continue-on-error: true

  complexity-check:
    name: Code Complexity Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup NetBird VPN
        uses: ./.github/actions/setup-netbird
        with:
          setup-key: ${{ secrets.NETBIRD_SETUP_KEY }}

      - name: Install radon
        run: |
          pip install radon

      - name: Check cyclomatic complexity
        run: |
          radon cc morgan-rag/morgan/ -a -nb || true
          radon cc morgan-rag/morgan/ -nc || true

      - name: Check maintainability index
        run: |
          radon mi morgan-rag/morgan/ -nb || true

      - name: Cleanup NetBird VPN
        if: always()
        uses: ./.github/actions/cleanup-netbird

  summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint, format-check, yaml-lint, dockerfile-lint, shell-check, complexity-check]
    if: always()

    steps:
      - name: Check lint results
        run: |
          echo "::notice::Linting checks completed"
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "::warning::Code quality checks found issues"
          fi
